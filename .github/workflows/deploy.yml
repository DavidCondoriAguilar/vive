name: ğŸš€ Deploy to Hostinger

# Trigger del workflow
on:
  push:
    branches:
      - main  # Cambia a 'master' si usas master como rama principal
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

# Variables de entorno globales
env:
  NODE_VERSION: '20'  # VersiÃ³n de Node.js

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: BUILD - Construir la aplicaciÃ³n
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      # 2. Setup de Node.js
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      # 3. Instalar dependencias
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      # 4. Crear archivo .env.production con secrets
      - name: ğŸ” Create .env.production file
        run: |
          echo "VITE_BRAND_NAME=${{ secrets.VITE_BRAND_NAME }}" >> .env.production
          echo "VITE_BRAND_EMAIL=${{ secrets.VITE_BRAND_EMAIL }}" >> .env.production
          echo "VITE_WHATSAPP_NUMBER=${{ secrets.VITE_WHATSAPP_NUMBER }}" >> .env.production
          echo "VITE_PRODUCTION_URL=${{ secrets.VITE_PRODUCTION_URL }}" >> .env.production
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env.production
          echo "VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}" >> .env.production
          echo "VITE_FB_PIXEL_ID=${{ secrets.VITE_FB_PIXEL_ID }}" >> .env.production
        
      # 5. Build de producciÃ³n
      - name: ğŸ”¨ Build for production
        run: npm run build
        env:
          NODE_ENV: production
          
      # 6. Verificar que dist se haya creado
      - name: âœ… Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist folder not found!"
            exit 1
          fi
          echo "âœ… Build successful! dist folder created."
          ls -la dist/
          
      # 7. Upload del artifact (dist folder)
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 1  # Solo guardamos 1 dÃ­a
          
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: DEPLOY - Desplegar a Hostinger vÃ­a FTP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš¢ Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: build  # Espera a que build termine
    
    steps:
      # 1. Download del artifact
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/
          
      # 2. Verificar contenido descargado
      - name: ğŸ” Verify downloaded files
        run: |
          echo "ğŸ“‚ Contents of dist folder:"
          ls -la dist/
          
      # 3. Deploy vÃ­a FTP a Hostinger
      - name: ğŸš€ Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}  # Ej: /public_html/ o /htdocs/
          protocol: ftps  # Usa 'ftp' si Hostinger no soporta FTPS
          port: 21  # Puerto FTP estÃ¡ndar
          dangerous-clean-slate: false  # SEGURIDAD: No borrar todo antes de subir
          
      # 4. NotificaciÃ³n de Ã©xito
      - name: âœ… Deployment successful
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site URL: ${{ secrets.VITE_PRODUCTION_URL }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: NOTIFY - NotificaciÃ³n (opcional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: deploy
    if: always()  # Ejecutar siempre, incluso si falla
    
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            # AquÃ­ puedes agregar notificaciones a Slack, Discord, Email, etc.
          else
            echo "âŒ Deployment failed!"
          fi
